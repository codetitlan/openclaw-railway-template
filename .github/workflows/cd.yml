# ─────────────────────────────────────────────────────────────────────────────
# .github/workflows/cd.yml  — copy this into every service repo
#
# Triggers: every push to main (= every merged PR)
#
# Required GitHub environment variables (Settings → Environments):
#   dev environment:
#     DEV_URL                  https://your-service-dev.up.railway.app
#     RAILWAY_SERVICE_ID_DEV   Railway service ID for dev
#   production environment:
#     PROD_URL                 https://your-service.up.railway.app
#     RAILWAY_SERVICE_ID_PROD  Railway service ID for production
#
# Required GitHub secrets (Settings → Environments):
#   dev environment:        RAILWAY_TOKEN_DEV
#   production environment: RAILWAY_TOKEN_PROD
#
# Optional secrets (added to any environment if you use them):
#   SLACK_WEBHOOK_URL        Enables Slack deployment notifications
#
# Customise:
#   - Override integration-test-command if not using npm run test:integration
#   - Override unit-test-command if not using npm test
#   - Override health-check-path if not using /health
#   - Override node-version as needed
# ─────────────────────────────────────────────────────────────────────────────
name: CD

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write    # required for pushing to ghcr.io

jobs:
  pipeline:
    # Using commit SHA instead of v3 tag to bypass reference resolution issues
    # SHA: 08b9bb1 = v3 (includes Railway debugging and project-id support)
    uses: bb-claw/ci-workflows/.github/workflows/full-pipeline.yml@08b9bb1ed9e061ac5cbfa801abb53273ca4ec98f
    with:
      dev-url:                  ${{ vars.DEV_URL }}
      prod-url:                 ${{ vars.PROD_URL }}
      railway-service-id-dev:   ${{ vars.RAILWAY_SERVICE_ID_DEV }}
      railway-service-id-prod:  ${{ vars.RAILWAY_SERVICE_ID_PROD }}
      railway-project-id-dev:   ${{ vars.RAILWAY_PROJECT_ID_DEV }}
      railway-project-id-prod:  ${{ vars.RAILWAY_PROJECT_ID_PROD }}
      package-manager:           pnpm
      # ── Optional overrides (uncomment to customise) ──────────────────────
      # dockerfile:              "./Dockerfile"
      health-check-path:         "/health"
      unit-test-command:         "npm run lint"
      integration-test-command:  "bash scripts/integration-tests.sh"
      # node-version:            "22"
    secrets: inherit
