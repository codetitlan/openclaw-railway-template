name: Health Check Primary Instance

on:
  workflow_call:
    inputs:
      health_check_url:
        required: true
        type: string
        description: 'Base URL of the primary instance (e.g., https://app.railway.app)'
      initial_wait_seconds:
        required: false
        type: number
        default: 60
        description: 'Seconds to wait before first health check'
      max_attempts:
        required: false
        type: number
        default: 60
        description: 'Maximum number of check attempts (at 10 sec intervals)'

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Wait Before Health Check
        run: |
          WAIT_SECONDS=${{ inputs.initial_wait_seconds }}
          echo "‚è≥ Waiting ${WAIT_SECONDS} seconds before first health check..."
          sleep $WAIT_SECONDS

      - name: Verify Primary Instance Health
        run: |
          HEALTH_URL="${{ inputs.health_check_url }}/setup/healthz"
          MAX_ATTEMPTS=${{ inputs.max_attempts }}
          
          echo "üîç Checking health endpoint: ${HEALTH_URL}"
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "‚úÖ Primary instance is healthy (attempt $i/$MAX_ATTEMPTS)"
              exit 0
            fi
            echo "‚è≥ Attempt $i/$MAX_ATTEMPTS - instance not ready yet..."
            sleep 10
          done
          
          echo "‚ùå Primary instance health check failed after $(($MAX_ATTEMPTS * 10)) seconds"
          exit 1

      - name: Health Check Success
        if: success()
        run: |
          echo "‚úÖ Primary instance verified healthy - ready for buddy deployment"
