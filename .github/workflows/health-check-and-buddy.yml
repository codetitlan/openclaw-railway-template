name: Health Check & Buddy Deployment

on:
  workflow_run:
    workflows: [Docker build]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  actions: write

jobs:
  # Health check for primary instance after successful deployment
  health-check:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait before health check
        run: sleep 60

      - name: Health check
        run: |
          HEALTH_URL="${{ secrets.RAILWAY_PRIMARY_URL }}/setup/healthz"
          echo "üîç Checking health endpoint: ${HEALTH_URL}"
          
          for i in {1..60}; do
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "‚úÖ Primary instance is healthy (attempt $i/60)"
              exit 0
            fi
            echo "‚è≥ Attempt $i/60 - instance not ready yet..."
            sleep 10
          done
          
          echo "‚ùå Primary instance health check failed after 10 minutes"
          exit 1

  # Trigger buddy instance deployment after successful health check
  trigger-buddy:
    needs: health-check
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Buddy Deployment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ü§ù Triggering buddy instance deployment workflow...');
            
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-buddy.yml',
              ref: 'main',
              inputs: {
                buddy_duration_hours: '2'
              }
            });
            
            console.log('‚úÖ Buddy deployment workflow triggered');
