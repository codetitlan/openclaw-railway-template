name: Health Check & Buddy Deployment

on:
  workflow_run:
    workflows: [Docker build]
    types: [completed]
    branches: [main]

jobs:
  # Health check for primary instance after successful deployment
  health-check:
    if: github.event.workflow_run.conclusion == 'success'
    uses: ./.github/workflows/health-check.yml
    with:
      health_check_url: ${{ secrets.RAILWAY_PRIMARY_URL }}
      initial_wait_seconds: 60
      max_attempts: 60

  # Trigger buddy instance deployment after successful health check
  trigger-buddy:
    needs: health-check
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Buddy Deployment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ü§ù Triggering buddy instance deployment workflow...');
            
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-buddy.yml',
              ref: 'main',
              inputs: {
                buddy_duration_hours: '2'
              }
            });
            
            console.log('‚úÖ Buddy deployment workflow triggered');
