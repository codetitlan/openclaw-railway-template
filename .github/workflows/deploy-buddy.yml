name: Deploy Buddy Instance

on:
  workflow_dispatch:
    inputs:
      buddy_duration_hours:
        description: 'How long to run buddy (hours)'
        required: false
        default: '2'

env:
  RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
  RAILWAY_BUDDY_SERVICE_ID: ${{ secrets.RAILWAY_BUDDY_SERVICE_ID }}
  RAILWAY_BUDDY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_BUDDY_ENVIRONMENT_ID }}

jobs:
  deploy-buddy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Redeploy Buddy on Railway
        if: env.RAILWAY_API_TOKEN != '' && env.RAILWAY_BUDDY_SERVICE_ID != '' && env.RAILWAY_BUDDY_ENVIRONMENT_ID != ''
        run: |
          set -euo pipefail

          echo "ü§ù Deploying buddy instance..."
          
          # Fetch latest deployment for buddy service
          echo "Fetching latest deployment for buddy service..."
          DEPLOYMENT_ID=$(curl -sf https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${RAILWAY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { deployments(first: 1, input: { serviceId: \"'"${RAILWAY_BUDDY_SERVICE_ID}"'\", environmentId: \"'"${RAILWAY_BUDDY_ENVIRONMENT_ID}"'\" }) { edges { node { id status } } } }"
            }' | jq -r '.data.deployments.edges[0].node.id')

          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" = "null" ]; then
            echo "::error::Could not find a deployment to redeploy"
            exit 1
          fi

          echo "Triggering redeploy for buddy deployment ${DEPLOYMENT_ID}..."
          RESULT=$(curl -sf https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${RAILWAY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { deploymentRedeploy(id: \"'"${DEPLOYMENT_ID}"'\") { id status } }"
            }')

          STATUS=$(echo "$RESULT" | jq -r '.data.deploymentRedeploy.status // empty')
          if [ -z "$STATUS" ]; then
            echo "::error::Redeploy failed: $RESULT"
            exit 1
          fi

          echo "‚úÖ Buddy redeploy triggered ‚Äî new deployment status: ${STATUS}"

      - name: Wait for Buddy Instance to Start
        run: |
          echo "‚è≥ Waiting 60 seconds for buddy instance to stabilize..."
          sleep 60

      - name: Health Check Buddy Instance
        run: |
          RAILWAY_BUDDY_URL="${{ secrets.RAILWAY_BUDDY_URL }}"
          
          if [ -z "$RAILWAY_BUDDY_URL" ]; then
            echo "‚ö†Ô∏è RAILWAY_BUDDY_URL not configured, skipping health check"
            exit 0
          fi

          HEALTH_URL="${RAILWAY_BUDDY_URL}:8888/health"
          echo "üîç Checking buddy instance health: ${HEALTH_URL}"
          
          for i in {1..60}; do
            if curl -sf "$HEALTH_URL" | jq -e '.status' > /dev/null 2>&1; then
              HEALTH_STATUS=$(curl -sf "$HEALTH_URL" | jq -r '.status')
              echo "‚úÖ Buddy instance is $HEALTH_STATUS (attempt $i/60)"
              exit 0
            fi
            echo "‚è≥ Attempt $i/60 - buddy instance not ready yet..."
            sleep 10
          done
          
          echo "‚ö†Ô∏è Buddy health check timeout after 10 minutes (continuing anyway)"
          exit 0

      - name: Buddy Deployment Complete
        run: |
          DURATION_HOURS="${{ github.event.inputs.buddy_duration_hours }}"
          echo "‚úÖ Buddy instance deployed and verified healthy"
          echo "‚ÑπÔ∏è Buddy will run for ${DURATION_HOURS} hour(s) on Railway independently"
